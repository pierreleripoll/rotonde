{% extends "layout.html" %}
{% set active_page = 'set_spectacle' %}

{% block head %}
  {{ super() }}


<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/js/plugins/piexif.min.js" type="text/javascript"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/js/plugins/sortable.min.js" type="text/javascript"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/js/plugins/purify.min.js" type="text/javascript"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<!-- the main fileinput plugin file -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/js/fileinput.min.js" type="text/javascript"></script>
<!-- optionally uncomment line below for loading your theme assets for a theme like Font Awesome (`fa`) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/themes/fa/theme.min.js"></script>

<script src="/static/color-thief.js"></script>
<script src="/static/jquery.guillotine.js"></script>
<script src="/static/jquery.guillotine.min.js"></script>
<script>
    var contactAffiche = 0
    function addNewContact() {
      var div = document.createElement("div");
      var inputName = document.createElement("INPUT");
      inputName.setAttribute("type", "text");
      inputName.setAttribute("id", "nomUser");
      inputName.setAttribute("class", "form-control");
      inputName.setAttribute("name", "nomUser");
      inputName.setAttribute("placeholder","Nom");

      div.appendChild(inputName);

      var inputPrenom = document.createElement("input");
      inputPrenom.setAttribute("type", "text");
      inputPrenom.setAttribute("id", "prenomUser");
      inputPrenom.setAttribute("class", "form-control");
      inputPrenom.setAttribute("name", "prenomUser");
      inputPrenom.setAttribute("placeholder","Prenom");

      div.appendChild(inputPrenom);

      var telephone = document.createElement("input");
      telephone.setAttribute("type", "integer");
      telephone.setAttribute("id", "telephone");
      telephone.setAttribute("name", "telephone");
      telephone.setAttribute("placeholder","Numero de Telephone");

      div.appendChild(telephone);

      var adressemail = document.createElement("input");
      adressemail.setAttribute("type", "text");
      adressemail.setAttribute("id", "adressemail");
      adressemail.setAttribute("class", "form-control");
      adressemail.setAttribute("name", "adressemail");
      adressemail.setAttribute("placeholder","Adresse email");

      div.appendChild(adressemail);

      var annee = document.createElement("select");
      annee.id = "anneeSelect";
      annee.name="anneeSelect";

      for (var x = 0; x < 6; x++) {
          var option = document.createElement("option");
          option.value = x;
          option.text = x;
          annee.appendChild(option);
      }
      div.appendChild(annee);


      var depart = document.createElement("select");
      depart.id = "departSelect";
      depart.name="departSelect";

      departement = ["exterieur","Bioscience","GCU","GE","GEN","GI","GM","IF","PC","SGM","TC"];
      for (var x = 0; x < departement.length; x++) {
          var option = document.createElement("option");
          option.value = departement[x];
          option.text = departement[x];
          depart.appendChild(option);
      }
      div.appendChild(depart);

      var bouton = document.createElement("input");
      bouton.setAttribute("name", "boutonContact");
      bouton.setAttribute("id", "boutonContact");
      bouton.setAttribute("value", "Valider Contact");
      bouton.setAttribute("type","button");
      bouton.setAttribute("onclick","envoieContact()");

      div.appendChild(bouton);

      if (contactAffiche == 0) {
        contactAffiche=1
        document.getElementById("contact").appendChild(div);
        document.getElementById("addContactbutton").innerHTML = "Annuler Contact";
      } else if (contactAffiche == 1) {
        contactAffiche=0
        document.getElementById("addContactbutton").innerHTML = "Ajouter Contact";
        document.getElementById("contact").innerHTML = "";
      }
    }

    function envoieContact() {
      var nomUser = $("#nomUser").val();
      var prenomUser = $("#prenomUser").val();
      var tel = $("#telephone").val();
      var mail = $("#adressemail").val();
      var anneeSelect = $("#anneeSelect").val();
      var departSelect = $("#departSelect").val();
    $.ajax({
      url: "/api/ajoutContact/"+nomUser+"/"+prenomUser+"/"+tel+"/"+mail+"/"+anneeSelect+"/"+departSelect,
      success: function(data) {
        var option = document.createElement("option");
        option.value = data.id;
        option.text = data.nom+" "+data.prenom+" "+data.an+data.dep;
        document.getElementById("ajoutContactDB").appendChild(option);
        addNewContact();
      },
      error: function() {

      }
    });
    }

    var i = 0;
    var datesLength = {{nDates}};
    init(datesLength);

    function init(val) {
      i = val;
    }
    function addOneDate() {
      var lastDate = document.getElementById("datetime" + i.toString());
      var lastNPlaces = document.getElementById("nPlaces" + i.toString());

      var div = document.createElement("div");
      var inputDate = document.createElement("INPUT");
      inputDate.setAttribute("type", "datetime-local");
      i++;
      inputDate.setAttribute("name", "datetime" + i.toString());
      inputDate.setAttribute("id", "datetime" + i.toString());
      console.log(i);

      var br = document.createElement("br");

      div.appendChild(inputDate);

      var nPlace = document.createElement("input");
      nPlace.setAttribute("type", "number");
      nPlace.setAttribute("id", "nPlaces" + i.toString());
      nPlace.setAttribute("name", "nPlaces" + i.toString());
      nPlace.setAttribute("min", "0");
      nPlace.setAttribute("max", "500");

      if (lastDate) {
        inputDate.setAttribute("value", lastDate.value);
      }
      if (lastNPlaces) {
        nPlace.setAttribute("value", lastNPlaces.value);
      }

      div.appendChild(nPlace);

      document.getElementById("date-div").appendChild(br);
      document.getElementById("date-div").appendChild(div);
    }

    function add_new_file(field, maxsize){
    	var FileSize = field.files[0].size;
      if (FileSize > maxsize) {
      	alert('Image '+field.files[i].name+' trop grande: taille limitée à '+maxsize+' octets');
      } else {
      	var count = parseInt(document.getElementById('file_count').value);

      	var file_name = document.getElementById("new_file["+count+"]").value;
        console.log("nom du fichier", file_name);
        file_name = file_name.substr(file_name.lastIndexOf('\\')+1);

      	document.getElementById('new_file_row').style.display = "none";
      	document.getElementById('new_file_row').id = "new_file_row["+count+"]";
      	var table = document.getElementById('files_table');

      	var row = table.insertRow(table.rows.length);
      	row.id = "inserted_file["+count+"]";
      	var cell0 = row.insertCell(0);
      	cell0.innerHTML = '<input type="text" name="inserted_file['+count+']" value="'+file_name+'" /><input type="button" name="delete['+count+']" value="Delete" onclick="delete_inserted(this)"/>';

      	++count;

      	var row = table.insertRow(table.rows.length);
      	row.id = "new_file_row";
      	var cell0 = row.insertCell(0);
      	cell0.innerHTML = '<input type="file" name="photos" id="new_file['+count+']" readonly="readonly" onchange="add_new_file(this,'+maxsize+')" accept=".png, .jpg, .jpeg"/>';

      	document.getElementById('file_count').value = count;
      }
    }
    function delete_inserted(field, alreadysaved){
      var name = field.name;
      var id = name.substr(name.indexOf('[') + 1, name.indexOf(']') - name.indexOf('[') - 1);
      document.getElementById("inserted_file["+id+"]").style.display = "none";
      if(alreadysaved == 0){
    		var control = document.getElementById("new_file["+id+"]");
    		control.parentNode.removeChild(control);
    	}
    }

    function validateForm(){
      console.log("hey les amis");
      return true;
    }


    $(document).ready(function() {
      colorThief = new ColorThief();

      var urls = [];
      {%for path in paths%}
        urls.push('{{path}}');
      {%endfor%}
      var uploadPath = "/api/uploadFile/";
      console.log("Test");
      var nomSpectacleURL = encodeURI("{{spectacle.nom}}");
      console.log(nomSpectacleURL);
      var filenames = [];
      var file_name = "";
      {%for i in range(paths|length)%}

        file_name = urls[{{i}}];
        file_name = file_name.substr(file_name.lastIndexOf('/')+1);

        filenames.push(file_name);
      {%endfor%}



      $("#input-25").fileinput({
        initialPreview: [urls[0] {%for i in range(1,paths|length)%} ,urls[{{i}}] {%endfor%}],
        initialPreviewAsData: true,
        initialPreviewFileType: 'image',
        showDrag : true,
        initialPreviewConfig: [
          {%for i in range(paths|length)%}
          {caption: filenames[{{i}}], filename: filenames[{{i}}],url:'/api/deleteFile/{{spectacle.nom}}/'+filenames[{{i}}],key: {{i}} },
          {%endfor%}
        ],
        uploadUrl: "/api/uploadFile/"+nomSpectacleURL+'/',
        overwriteInitial: false,
        maxFileSize: 1000,
        allowedFileExtensions: ["jpg","png","gif"]
      }).on('filebeforedelete', function() {
        var aborted = !window.confirm('Êtes-vous sûr de vouloir supprimer cette photo ?');
        return aborted;

      }).on('filedeleted', function() {
        setTimeout(function() {
            window.alert('Suppression réussie ! ');
        });
    });
    });




</script>


{% endblock %}

{% block title %}Modification spectacle{% endblock %}

{% block content %}
  <div class="container-fluid">
    <p>Bienvenue sur la page de modification/création de spectacle : </p>
    <p>{{spectacle.nom}}</p>

    <label for="input-25">Photos:</label>
    <div class="file-loading">
        <input id="input-25" name="photos" type="file" multiple>
    </div>

    <script>
      var picture = $('#thepicture');  // Must be already loaded or cached!
      picture.guillotine({width: 400, height: 300});
    </script>



    <form action="" method="POST" name="formulaire"onsubmit="return validateForm()" enctype="multipart/form-data">
      <div class="form-group">
        <label for="nom du spectacle">Nom du spectacle:<abbr title="required"></abbr></label><br>
        <input type="text" id="nom" class="form-control" name="nom" value='{{spectacle.nom}}'><br>
      </div>
      <div class="form-group">
        <label for="resume">Résumé:</label><br>
        <textarea type="text" id="resume" row="4" class="form-control" name="resume" >{{spectacle.resume}}</textarea>
      </div>
      <div class="form-group">
      </div>

      <div class="form-group">
        <label for="liens">Liens:</label><br>
        <input type="url" name="liens" class="form-control" value='{%if spectacle.liens != None%}{{spectacle.liens}}{%endif%}'><br>
      </div>
      <div class="form-group">
        <label for="directeur">Par:</label><br>
        <input type="text" name="directeur" class="form-control" value='{{spectacle.directeur}}'><br>
      </div>
      <div class="form-group">
        <label for="auteur">Auteur:</label><br>
        <input type="text" name="auteur" class="form-control" value='{{spectacle.auteur}}'><br>
      </div>
      <div class="form-group">
        <label for="participants">Avec:</label><br>
        <input type="text" name="participants" class="form-control" value='{{spectacle.participants}}'><br>
      </div>
      <div class="form-group">
        <label for="typeSpectacle">Genre:</label><br>
        <select type="text" name="typeSpectacle" class="form-control" value='{{spectacle.typeSpectacle}}'>
          <option value="Théâtre">Théâtre</option>
          <option value="Musique">Musique</option>
          <option value="Danse">Danse</option>
          <option value="Impro">Impro</option>
          <option value="Conférence">Conférence</option>
          <option value="Cirque">Cirque</option>
          <option value="Performance">Performance</option>
          <option value="Autre">Autre</option>
        </select><br>
      </div>
      <div class="form-group">
        <label for="duree">Durée (en minutes):</label><br>
        <input type="number" name="duree" class="form-control" value='{{spectacle.duree}}'><br>
      </div>
      <div class="form-group">
        <label for="tarif">Tarif:</label><br>
        <input type="number" name="tarif" class="form-control" value='{{spectacle.tarif}}'><br>
      </div>
      <div class="form-group">
        <label for="infoComplementaire">Info complémentaire:</label><br>
        <input type="text" name="infoComplementaire" class="form-control" value='{{spectacle.infoComplementaire}}'><br>
      </div>
      <div class="form-group">
        <select name="ajoutContactDB" id="ajoutContactDB">
          {%for c in contact:%}
          <option value="{{c.id}}">{{c.nom}} {{c.prenom}} {{c.annee}}{{c.depart}}</option>
          {%endfor%}
        </select>
        <button type="button" id="addContactbutton" onclick="addNewContact();" name="addContactbutton">Ajouter Contact</button>
        <br>
        <br>
        <div id="contact"></div>
      </div>
      <br>
      <div>
        <label for="dates">Dates :  </label>
        <button type="button" id="addDate" onclick="addOneDate()" name="addDate" valur="addDate">Add</button><br>
        <div id="date-div">
          {%for date in dates:%}
          <div id="date{{loop.index}}">
            <input type="datetime-local" value="{{date.date}}" id="datetime{{loop.index}}" name="datetime{{loop.index}}">
            <input type="number" value="{{date.placesRestantes}}" id="nPlaces{{loop.index}}" name="nPlaces{{loop.index}}" min="0" max="500">
          </div>
          {%endfor%}
        </div>
      </div>

      <div>
        <br><br>
        <button name="button" id="valide" value="valider" type="valide" }>Valider</button>
      </div>
    </form>
  </div>

  <script>

  </script>
{% endblock %}
